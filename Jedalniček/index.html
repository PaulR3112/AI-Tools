<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0f1a">
<title>Clean Eating Agent ‚Äî P≈ô√≠bram</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<style>
/* TVOJ P√îVODN√ù DIZAJN */
:root{--bg:#0a0f1a;--bg2:#111827;--bg3:#1a2236;--surface:#1e2a3e;--border:#2a3654;--text:#e8ecf4;--text2:#8b97b0;--accent:#22d3ee;--green:#34d399;--yellow:#fbbf24;--red:#f87171;--orange:#fb923c;--purple:#a78bfa;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);font-size:15px;line-height:1.5;overflow-x:hidden;padding-bottom:calc(80px + var(--safe-bottom))}
h1,h2,h3,p{margin:0}
#app-header{position:sticky;top:0;background:rgba(10,15,26,0.95);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:calc(16px + var(--safe-top)) 16px 16px;z-index:100;display:flex;flex-direction:column;gap:16px}
.header-top{display:flex;justify-content:space-between;align-items:center}
.logo{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:18px;background:linear-gradient(135deg,var(--accent),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.5px}
.search-box{position:relative;width:100%}
.search-input{width:100%;background:var(--bg2);border:1px solid var(--border);padding:12px 16px 12px 44px;border-radius:12px;color:var(--text);font-family:inherit;font-size:15px;transition:all .2s ease}
.search-input:focus{outline:none;border-color:var(--accent);background:var(--surface)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text2);pointer-events:none}
.filters{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.filters::-webkit-scrollbar{display:none}
.filter-chip{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:20px;font-size:13px;white-space:nowrap;cursor:pointer;transition:all .2s}
.filter-chip.active{background:var(--accent);color:#000;border-color:var(--accent);font-weight:500}
#feed{padding:16px;display:flex;flex-direction:column;gap:16px;max-width:600px;margin:0 auto}
.card{background:var(--surface);border-radius:16px;overflow:hidden;border:1px solid var(--border);position:relative}
.card-header{padding:16px;display:flex;justify-content:space-between;align-items:flex-start}
.product-name{font-weight:700;font-size:17px;line-height:1.3;margin-bottom:4px;color:var(--text)}
.product-meta{display:flex;gap:10px;font-size:13px;color:var(--text2)}
.score-badge{background:var(--bg2);padding:4px 8px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-weight:700;font-size:13px;border:1px solid var(--border)}
.price-section{padding:0 16px 16px;display:flex;align-items:flex-end;gap:8px}
.current-price{font-size:20px;font-weight:700;color:var(--text)}
.old-price{text-decoration:line-through;color:var(--text2);font-size:14px}
.discount-badge{background:rgba(239,68,68,0.15);color:var(--red);font-size:12px;font-weight:700;padding:2px 6px;border-radius:4px}
.store-info{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:13px;color:var(--text2)}
.store-name{color:var(--accent);font-weight:500}
/* Loading stav */
#loading-msg { text-align: center; color: var(--text2); padding: 40px; font-style: italic; }
</style>
</head>
<body>

<div id="app-header">
    <div class="header-top">
        <div class="logo">CleanAgent_Alpha</div>
    </div>
    <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" placeholder="Hƒæada≈• potraviny..." id="searchInput">
    </div>
    <div class="filters">
        <div class="filter-chip active" onclick="filterData('all', this)">V≈°etko</div>
        <div class="filter-chip" onclick="filterData('pantry', this)">≈†pajza</div>
        <div class="filter-chip" onclick="filterData('fridge', this)">Chladniƒçka</div>
        <div class="filter-chip" onclick="filterData('protein', this)">Bielkoviny</div>
    </div>
</div>

<main id="feed">
    <div id="loading-msg">Prip√°jam sa k datab√°ze...</div>
</main>

<script>
    // ==========================================
    // 1. KONFIGUR√ÅCIA (SEM VLO≈Ω SVOJE √öDAJE)
    // ==========================================
    const SUPABASE_URL = 'https://tvoj-projekt.supabase.co'; // ‚ö†Ô∏è Prep√≠≈°
    const SUPABASE_KEY = 'tvoj-ey-kod';                     // ‚ö†Ô∏è Prep√≠≈°

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let allProducts = []; // Tu bud√∫ ≈æi≈• tvoje d√°ta z cloudu

    // ==========================================
    // 2. HLAVN√Å LOGIKA
    // ==========================================

    async function initApp() {
        console.log("Startujem aplik√°ciu...");
        
        // Stiahni d√°ta z tabuƒæky 'potraviny'
        const { data, error } = await supabase
            .from('potraviny')
            .select('*');

        const feed = document.getElementById('feed');
        
        if (error) {
            console.error(error);
            feed.innerHTML = `<div style="text-align:center;color:red;padding:20px">Chyba pripojenia. Skontroluj konzolu.</div>`;
            return;
        }

        if (!data || data.length === 0) {
            feed.innerHTML = `<div style="text-align:center;padding:20px">
                Datab√°za je pr√°zdna.<br><br>
                <button onclick="uploadDataToSupabase()" style="padding:10px;background:var(--accent);border:none;border-radius:8px">Nahra≈• d√°ta (Klikni raz)</button>
            </div>`;
            return;
        }

        // Spracovanie d√°t (rozbalenie JSONu)
        allProducts = data.map(item => ({
            id: item.id,
            name: item.name,
            category: item.category,
            best_price: item.best_price,
            clean_score: item.clean_score,
            ...item.full_data // Rozbal√≠ detaily
        }));

        renderCards(allProducts);
        
        // Aktivuj vyhƒæad√°vanie
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term));
            renderCards(filtered);
        });
    }

    function renderCards(items) {
        const feed = document.getElementById('feed');
        feed.innerHTML = ''; // Vyƒçisti

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            
            // Farba sk√≥re
            let scoreColor = '#34d399';
            if(item.clean_score < 80) scoreColor = '#fbbf24';
            if(item.clean_score < 60) scoreColor = '#f87171';

            // N√°jdi najlep≈°iu ponuku (ak existuje)
            const offer = item.offers ? item.offers[0] : null;
            const storeName = offer ? offer.store : 'Nezn√°my obchod';
            const regularPrice = item.regular_price || (item.best_price * 1.2);
            const discount = Math.round((1 - (item.best_price / regularPrice)) * 100);

            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <div class="product-name">${item.name}</div>
                        <div class="product-meta">
                            <span>${item.category}</span>
                            <span>‚Ä¢</span>
                            <span>${item.nutrition ? item.nutrition.kcal + ' kcal' : ''}</span>
                        </div>
                    </div>
                    <div class="score-badge" style="color:${scoreColor};border-color:${scoreColor}40">
                        ${item.clean_score}
                    </div>
                </div>
                <div class="price-section">
                    <span class="current-price">${item.best_price} Kƒç</span>
                    ${discount > 0 ? `
                    <span class="old-price">${regularPrice.toFixed(1)}</span>
                    <span class="discount-badge">-${discount}%</span>
                    ` : ''}
                </div>
                <div class="store-info" style="margin:0 16px 16px 16px">
                    <span class="store-name">üìç ${storeName}</span>
                    <span>Do: ${offer ? offer.valid_until.slice(5) : '?'}</span>
                </div>
            `;
            feed.appendChild(card);
        });
    }

    function filterData(category, element) {
        // Vizu√°lna zmena tlaƒçidiel
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        element.classList.add('active');

        if (category === 'all') {
            renderCards(allProducts);
        } else {
            const filtered = allProducts.filter(p => p.category === category);
            renderCards(filtered);
        }
    }

    // Spusti appku
    initApp();


    // ==========================================
    // 3. MIGRAƒåN√ù N√ÅSTROJ (Spusti iba raz)
    // ==========================================
    // Toto s√∫ tvoje p√¥vodn√© d√°ta z JSONu
    const dataToUpload = [
    {
        "name": "Fazole v tomatƒõ Heinz 400g",
        "category": "pantry",
        "best_price": 19.9,
        "clean_score": 88,
        "full_data": {
            "regular_price": 34.9,
            "max_discount": 43,
            "nutrition": {"kcal": 81, "protein": 4.6},
            "offers": [
                {"store": "Tesco", "valid_until": "2026-02-17"}
            ]
        }
    },
    {
        "name": "Med kvƒõtov√Ω Medokomerc 900g",
        "category": "pantry",
        "best_price": 129.9,
        "clean_score": 65,
        "full_data": {
            "regular_price": 189.9,
            "offers": [
                {"store": "Kaufland", "valid_until": "2026-02-19"}
            ]
        }
    }
    ];

    async function uploadDataToSupabase() {
        console.log("Nahr√°vam d√°ta...");
        document.getElementById('feed').innerHTML = "Nahr√°vam d√°ta... ƒåakaj.";
        
        for (const item of dataToUpload) {
            const { error } = await supabase
                .from('potraviny')
                .insert({
                    name: item.name,
                    category: item.category,
                    best_price: item.best_price,
                    clean_score: item.clean_score,
                    full_data: item.full_data
                });
            if(error) console.error("Chyba:", error);
        }
        
        alert("Hotovo! Obnov str√°nku (F5).");
        location.reload();
    }
</script>
</body>
</html>