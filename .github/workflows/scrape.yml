name: "ğŸ”¬ Clean Eating Scraper â€” Kupi.cz"

# SpÃºÅ¡Å¥a sa automaticky podÄ¾a letÃ¡kovÃ©ho cyklu:
# Pon 06:00 â€” Lidl novÃ© letÃ¡ky
# Str 06:00 â€” Kaufland, Billa, Albert novÃ© letÃ¡ky
# Å tv 06:00 â€” Lidl Å¡tvrtkovÃ¡ akcia, Penny
# + manuÃ¡lne cez GitHub UI
on:
  schedule:
    - cron: "0 5 * * 1"   # Pondelok 06:00 CET (05:00 UTC)
    - cron: "0 5 * * 3"   # Streda 06:00 CET
    - cron: "0 5 * * 4"   # Å tvrtok 06:00 CET
  workflow_dispatch:        # ManuÃ¡lne spustenie

permissions:
  contents: write           # MusÃ­ vedieÅ¥ commitnÃºÅ¥ novÃ© dÃ¡ta

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: "ğŸ“¥ Checkout repozitÃ¡r"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: "ğŸ“¦ InÅ¡talÃ¡cia zÃ¡vislostÃ­"
        run: pip install -r requirements.txt

      - name: "ğŸ”¬ Spustenie scrapera"
        run: python scraper/kupi_scraper.py --output data

      - name: "ğŸ“Š Kontrola vÃ½sledkov"
        run: |
          echo "=== VÃ½sledky scrapu ==="
          cat data/summary.json | python -m json.tool
          echo ""
          echo "PoÄet produktov:"
          cat data/products.json | python -c "import sys,json; d=json.load(sys.stdin); print(f'  Celkom: {d[\"total_products\"]}')"

      - name: "ğŸ’¾ Commit a push novÃ½ch dÃ¡t"
        run: |
          git config user.name "Clean Eating Bot"
          git config user.email "bot@clean-eating.app"
          git add data/
          
          # Commit len ak sÃº zmeny
          if git diff --staged --quiet; then
            echo "Å½iadne novÃ© dÃ¡ta â€” skip"
          else
            DATUM=$(date +%Y-%m-%d)
            git commit -m "ğŸ”„ AktualizÃ¡cia letÃ¡kov $DATUM"
            git push
          fi
